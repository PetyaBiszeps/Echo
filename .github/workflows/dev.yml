name: Dev CI

on:
  push:
    branches: [dev]
    paths:
      - 'packages/client/**'
      - 'packages/server/**'
      - 'packages/shared/**'
      - '.github/workflows/dev.yml'
  pull_request:
    branches: [dev]
    paths:
      - 'packages/client/**'
      - 'packages/server/**'
      - 'packages/shared/**'
      - '.github/workflows/dev.yml'

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.changes.outputs.client }}
      server: ${{ steps.changes.outputs.server }}
      shared: ${{ steps.changes.outputs.shared }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          base: ${{ github.event.pull_request.base.ref || github.ref }}
          filters: |
            client:
              - 'packages/client/**'
            server:
              - 'packages/server/**'
            shared:
              - 'packages/shared/**'

      - name: Debug detected changes
        run: |
          echo "Client changes: ${{ steps.changes.outputs.client }}"
          echo "Server changes: ${{ steps.changes.outputs.server }}"
          echo "Shared changes: ${{ steps.changes.outputs.shared }}"
          echo "Changed files:"
          echo "${{ steps.changes.outputs.changes }}"

  client:
    name: Frontend CI
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    concurrency:
      group: dev-ci-frontend-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Debug Node.js & Yarn
        run: |
          echo "Node: $(node -v)"
          echo "Yarn: $(yarn -v)"

      - name: Install monorepo dependencies
        run: yarn install --no-lockfile

      - name: Build shared
        run: yarn workspace @echo/shared build

      - name: Build client
        run: |
          if yarn --silent workspaces list | grep -q "@echo/client"; then 
            yarn workspace @echo/client build
          else
            echo "No @echo/client workspace found - skipping..."
          fi

  server:
    name: Backend CI
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    concurrency:
      group: dev-ci-backend-${{ github.ref }}
      cancel-in-progress: true

    container: node:22
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: echo
          POSTGRES_PASSWORD: echo
          POSTGRES_DB: echo
        ports: ['5432:5432']
        options: >-
          --health-cmd="pg_isready -U echo"
          --health-interval=5s --health-timeout=5s --health-retries=10

    env:
      DATABASE_URL: postgresql://echo:echo@postgres:5432/echo?schema=public
      JWT_ACCESS_SECRET: test_secret_for_ci
      CORS_ORIGIN: http://localhost:5173
      PORT: 3001

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Debug Node.js & Yarn
        run: |
          echo "Node: $(node -v)"
          echo "Yarn: $(yarn -v)"

      - name: Install monorepo dependencies
        run: yarn install --no-lockfile

      - name: Build shared
        run: yarn workspace @echo/shared build

      - name: Generate Prisma client
        run: yarn workspace @echo/server prisma generate

      - name: Apply DB migrations
        run: yarn workspace @echo/server prisma migrate deploy

      - name: Build server
        run: yarn workspace @echo/server build